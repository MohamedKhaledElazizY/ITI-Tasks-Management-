@using SmartTask.Core.Models
@using SmartTask.Web.ViewModels.DepartmentVM
@model DepartmentFormViewModel

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

<h1 class="visually-hidden">Edit Department</h1>

<style>
    .form-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #f4f6f9;
        padding: 20px;
    }

    .form-container {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 700px;
    }

    h3 {
        text-align: center;
        margin-bottom: 30px;
        color: #2c3e50;
        font-weight: 600;
    }

    label {
        font-weight: 500;
        color: #34495e;
        margin-top: 15px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .btn-group-custom {
        display: flex;
        justify-content: center;
        gap: 50px;
        margin-top: 30px;   
    }
    .btn
    {
        width :48% ;
        margin-top :30px ;
    }

    .select2-container--default .select2-selection--multiple {
        border-radius: 6px;
        padding: 6px;
        min-height: 38px;
        border: 1px solid #ced4da;
    }

    .select2-selection__choice {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
        color: white !important;
    }
</style>

<div class="form-wrapper">
    <div class="form-container">
        <h3><i class="bi bi-pencil-square me-2"></i>Edit Department</h3>
        <form asp-action="Edit">
            <input type="hidden" asp-for="Id" />

            <div class="form-group">
                <label asp-for="Name" class="form-label"></label>
                <input asp-for="Name" class="form-control" placeholder="Enter department name" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="ManagerId" class="form-label"></label>
                <select asp-for="ManagerId" asp-items="@ViewBag.Managers" class="form-control select2-single">
                    <option value="">-- Select Manager --</option>
                </select>
                <span asp-validation-for="ManagerId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label class="form-label">Branches</label>
                <select id="branchesDropdown"
                        name="SelectedBranchIds"
                        class="form-control select2-multiple"
                        multiple="multiple"
                        data-placeholder="-- Select Branches --">
                    @foreach (var branch in ViewBag.Branches as IEnumerable<Branch>)
                    {
                        <option value="@branch.Id" selected="@Model.SelectedBranchIds.Contains(branch.Id)">
                            @branch.Name
                        </option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Select Users</label>
                <select id="usersDropdown"
                        name="SelectedUserIds"
                        class="form-control select2-multiple"
                        multiple="multiple"
                        data-placeholder="-- Select Users --">
                </select>
            </div>

            <div class="btn-group-custom">
                <button type="submit" class="btn btn-success ">
                    <i class="bi bi-check-circle me-2"></i> Save
                </button>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="bi bi-x-circle me-1"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <script>
        $(document).ready(function () {
            $('.select2-multiple').select2({
                placeholder: $(this).data('placeholder'),
                allowClear: true,
                width: '100%'
            });

            var initialBranchIds = @Html.Raw(Json.Serialize(Model.SelectedBranchIds ?? new List<int>()));
            $('#branchesDropdown').val(initialBranchIds).trigger('change');

            $('#branchesDropdown').on('change', function () {
                var branchIds = $(this).val();
                loadUsers(branchIds);
            });

            var initialUserIds = @Html.Raw(Json.Serialize(Model.SelectedUserIds ?? new List<string>()));
            loadUsers(initialBranchIds, initialUserIds);

            function loadUsers(branchIds, selectedUserIds = []) {
                if (!branchIds || branchIds.length === 0) {
                    $('#usersDropdown').empty().trigger('change');
                    return;
                }
                $.ajax({
                    url: '@Url.Action("GetUsersByBranches", "Department")',
                    type: 'GET',
                    data: {
                        branchIds: branchIds,
                        departmentId: @Model.Id
                    },
                    traditional: true,
                    success: function (users) {
                        var $userDropdown = $('#usersDropdown');
                        $userDropdown.empty();
                        $.each(users, function (i, user) {
                            $userDropdown.append(
                                $('<option>', {
                                    value: user.id,
                                    text: user.fullName + ' (' + user.email + ')',
                                    selected: selectedUserIds.includes(user.id)
                                })
                            );
                        });
                        $userDropdown.trigger('change');
                    }
                });
            }
        });
    </script>
}
